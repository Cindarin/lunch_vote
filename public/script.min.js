function pad(e,t){var n=String(e);if(t>n.length)n=Array(t+1-n.length).join("0")+n;return n}function isNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}function cookie_get(e){if(!document.cookie||document.cookie=="")return null;cookie={};_.each(document.cookie.split("; "),function(e){val=e.split("=");cookie[val[0]]=val[1]});return cookie[e]}function cookie_set(e,t,n){var r=new Date;r.setDate(r.getDate()+n);document.cookie=e+"="+escape(t)+(n?"; expires="+r.toUTCString():"")}Object.keys=Object.keys||function(e){var t=[];for(var n in e)if(e.hasOwnProperty(n))t.push(n);return t};var view_model={group_id:null,date_fmt_string:"dddd MMMM d yyyy, h:mm:ss tt",foursquare_oauth_token:"0KI2ZGHKKLM2LICI2XAKN0XSCIDICP10USYPQDBAC2CVCJB5",tick_time:67,identicon_size:24,chat_scrollbar:null,config_location_autocomplete:null,add_entity_input_autocomplete:null,pending_select:null,clear_filter:null,tick:null,send_chat:null,trigger_vote:null,update_location:null,add_poll:null,cancel_poll:null,compare_entities:null,add_entity:null,remove_entity:null,share_email:null,toggle_admin:null,render_identicon:null,select_text:null,enhance_entity_with_external_info:null,find_config_entity_by_name:null,set_entity_detail_by_name:null,entity_detail_afterRender:null,entity_list_afterRender:null,chat_scrollbar_update:null,offset:ko.observable(0),state:ko.observable(null),user_count:ko.observable(0),chats:ko.observableArray([]),clock:ko.observable(0),ticks:ko.observable(0),vote:ko.observable(null),current_poll_start_ts:ko.observable(null),chat_input:ko.observable(""),loading:ko.observable(true),show_admin:ko.observable(false),add_poll_start_ts:ko.observable("now"),add_poll_duration:ko.observable("5"),add_poll_runoff_duration:ko.observable("2"),config_location_input:ko.observable(""),config_location_has_focus:ko.observable(false),config_location:ko.observable(null),add_entity_input:ko.observable(""),add_entity_input_has_focus:ko.observable(false),config_entities:ko.observableArray([]),filter:ko.observable(""),entity_detail:ko.observable(null),previous_poll:null,previous_poll_entities_by_vote:null,previous_poll_voters:null,current_poll:null,filtered_current_poll_entities:null,upcoming_polls:null,next_poll_ts:null,has_winner:null,is_tie:null,has_votes:null,previous_poll_winner:null,countdown_readout:null,tailing_chat:null,add_poll_start_ts_datejs:null,add_poll_start_ts_server:null,zero_entities:null,zero_upcoming_polls:null,add_poll_form_invalid:null};view_model.group_id=Object.keys($.url().param())[0];view_model.clear_filter=function(){view_model.filter("")};view_model.tick=function(){view_model.ticks(view_model.ticks()+1);var e=null;var t=view_model.current_poll();if(t)e=t.end_ts;else{var n=view_model.next_poll_ts();if(n)e=n}if(e!==null)view_model.clock(Math.max(0,(e+view_model.offset()-(new Date).getTime())/1e3))};view_model.send_chat=function(){var e=$.trim(view_model.chat_input().substring(0,256));if(e.length==0)return;socket.emit("chat",e);view_model.chat_input("")};view_model.trigger_vote=function(e){view_model.vote(e);view_model.set_entity_detail_by_name(e)};view_model.update_location=function(e){socket.emit("update_location",e)};view_model.add_poll=function(){if(view_model.add_poll_form_invalid())return;socket.emit("add_poll",{start_ts:view_model.add_poll_start_ts_server(),duration:view_model.add_poll_duration(),runoff_duration:view_model.add_poll_runoff_duration()});if(view_model.add_poll_start_ts()=="now")view_model.show_admin(false);$("#powerTip").hide()};view_model.cancel_poll=function(e){socket.emit("cancel_poll",e.ts)};view_model.compare_entities=function(e,t){if(e.simple_name<t.simple_name)return-1;if(e.simple_name>t.simple_name)return 1;else return 0};view_model.add_entity=function(e){socket.emit("add_entity",e);view_model.enhance_entity_with_external_info(e,view_model.update_entity)};view_model.update_entity=function(e){socket.emit("update_entity",e.name,e);var t=view_model.entity_detail();if(t&&e&&t.name==e.name)view_model.entity_detail(e)};view_model.remove_entity=function(e){socket.emit("remove_entity",e.name)};view_model.toggle_admin=function(){view_model.show_admin(!view_model.show_admin())};view_model.show_admin.subscribe(function(e){$("#powerTip").hide()});view_model.render_identicon=function(e,t,n){var r=$(e).find("img.identicon")[0];if(typeof r=="undefined"||r.rendered)return;var i=Sha1.hash(n.author);r.setAttribute("data-identicon",i);r.width=view_model.identicon_size;r.height=view_model.identicon_size;Identicon(r);r.rendered=true};view_model.select_text=function(e,t){t.target.select()};view_model.enhance_entity_with_external_info=function(e,t){if(!e||!e.lat||!e.lng)return;var n="https://api.foursquare.com/v2/venues/search";var r="20120321";var i={intent:"browse",query:e.name,ll:e.lat+","+e.lng,radius:500,limit:1,v:r,oauth_token:view_model.foursquare_oauth_token};$.ajax({url:n,data:i,dataType:"jsonp",success:function(n,i,s){if(n.meta.code==200&&n.response.venues.length>=1){var o=n.response.venues[0].id;var u="https://api.foursquare.com/v2/venues/"+o;var a={v:r,oauth_token:view_model.foursquare_oauth_token};$.ajax({url:u,data:a,dataType:"jsonp",success:function(n,r,i){if(n.meta.code==200){var s=n.response.venue;var o=$.extend({loaded:true,rating:s.rating/2,review_count:s.stats.checkinsCount,categories:_.map(s.categories,function(e){return e.name})},e);t(o)}else{console.log(n)}},error:function(e,t,n){console.log(t+" "+n)}})}else{console.log(n)}},error:function(e,t,n){console.log(t+" "+n)}})};view_model.find_config_entity_by_name=function(e){var t=view_model.config_entities();for(var n=0;n<t.length;++n)if(t[n].name==e)return t[n];return null};view_model.set_entity_detail_by_name=function(e){if(!e)return;var t=view_model.find_config_entity_by_name(e.name);if(t)view_model.entity_detail(t)};view_model.entity_detail_afterRender=function(){$(".entity_detail *[title]").powerTip({placement:"e"});view_model.chat_scrollbar_update();setTimeout(view_model.chat_scrollbar_update,25)};view_model.entity_list_afterRender=function(){$(".entity_list *[title]").powerTip({placement:"e"})};view_model.chat_scrollbar_update=function(){view_model.chat_scrollbar.mCustomScrollbar("update");view_model.chat_scrollbar.mCustomScrollbar("scrollTo","bottom")};view_model.previous_poll=ko.computed(function(){var e=view_model.state();if(e&&e.poll.previous){var t=new Date(e.poll.previous.start_ts+view_model.offset());if(t.is().today())return e.poll.previous;else return null}else return null});view_model.previous_poll_entities_by_vote=ko.computed(function(){var e=view_model.previous_poll();if(e){var t=[];for(var n in e.tally){var r=e.tally[n];if(r>0)t.push({name:n,count:r})}t.sort(function(e,t){return t.count-e.count});return t}return null});view_model.previous_poll_voters=ko.computed(function(){var e=view_model.previous_poll();if(e){var t=[];for(var n in e.votes){t.push({entity:e.votes[n]})}return t}return null});view_model.current_poll=ko.computed(function(){var e=view_model.state();if(e){if(e.poll.current)view_model.current_poll_start_ts(e.poll.current.start_ts);return e.poll.current}else return null});view_model.current_poll_progress_pct=ko.computed(function(){view_model.ticks();var e=view_model.current_poll();if(e){var t=100*(((new Date).getTime()-(e.start_ts+view_model.offset()))/(e.end_ts+view_model.offset()-(e.start_ts+view_model.offset())));if(t<0)t=0;if(t>100)t=100;return t}else return 0});view_model.filtered_current_poll_entities=ko.computed(function(){var e=view_model.current_poll();var t=view_model.filter();var n=removeDiacritics(t).toLowerCase();if(e){var r=[];for(var i=0;i<e.entities.length;++i){var s=e.entities[i];var o=removeDiacritics(s).toLowerCase();if(o.indexOf(n)!=-1)r.push({name:s,simple_name:o,count:e.tally[s]})}r.sort(view_model.compare_entities);return r}return null});view_model.upcoming_polls=ko.computed(function(){var e=view_model.state();if(e){var t=[];if(e.poll.current)t.push({ts:-1,str:"started (in-progress)"});for(var n=0;n<e.poll.next_ts.length;++n){t.push({ts:e.poll.next_ts[n],str:(new Date(e.poll.next_ts[n]+view_model.offset())).toString(view_model.date_fmt_string)})}return t}return[]});view_model.next_poll_ts=ko.computed(function(){var e=view_model.state();if(e)if(e.poll.next_ts.length>0)return e.poll.next_ts[0];else return null;else return null});view_model.has_winner=ko.computed(function(){var e=view_model.previous_poll();if(e&&e.winner)return true;else return false});view_model.is_tie=ko.computed(function(){var e=view_model.previous_poll();if(e&&e.tie)return true;else return false});view_model.has_votes=ko.computed(function(){var e=view_model.previous_poll();if(e&&e.vote_count>0)return true;else return false});view_model.previous_poll_winner=ko.computed(function(){if(view_model.has_winner()){var e=view_model.previous_poll();if(e)return view_model.find_config_entity_by_name(e.winner)}return null});view_model.countdown_readout=ko.computed(function(){var e,t,n,r;e=view_model.clock();if(e<=0)return"";t=Math.floor(e/(60*60));e-=t*60*60;n=Math.floor(e/60);e-=n*60;r=Math.floor(e);if(t>0)return t+":"+pad(n,2)+":"+pad(r,2);else if(n>0)return n+":"+pad(r,2);else return r});view_model.add_poll_start_ts_datejs=ko.computed(function(){view_model.ticks();var e=Date.parse(view_model.add_poll_start_ts());if(e){return e.toString(view_model.date_fmt_string)}else return null});view_model.add_poll_start_ts_server=ko.computed(function(){view_model.ticks();var e=Date.parse(view_model.add_poll_start_ts());if(e){return e.getTime()-view_model.offset()}else return null});view_model.previous_poll_winner_directions_url=ko.computed(function(){var e=view_model.previous_poll_winner();if(!e)return null;var t=view_model.config_location();if(!t||!t.address)return null;return"http://maps.google.com/maps?q="+encodeURIComponent('"'+t.address+'"')+encodeURIComponent(" to ")+'"'+(e.lat&&e.lng?encodeURIComponent(e.name+", "):"")+encodeURIComponent(e.address)+'"'});view_model.zero_entities=ko.computed(function(){return view_model.config_entities().length==0});view_model.zero_upcoming_polls=ko.computed(function(){return view_model.upcoming_polls().length==0});view_model.add_poll_form_invalid=ko.computed(function(){var e=new Date;var t=Date.parse(view_model.add_poll_start_ts());if(t==null)return true;else if(t-e<0)return true;else if(!isNumber(view_model.add_poll_duration()))return true;else if(parseFloat(view_model.add_poll_duration())<0)return true;else if(!isNumber(view_model.add_poll_runoff_duration()))return true;else if(parseFloat(view_model.add_poll_runoff_duration())<0)return true;else if(view_model.zero_entities())return true;return false});ko.bindingHandlers.executeOnEnter={init:function(e,t,n,r){var i=n();$(e).keypress(function(e){var t=e.which?e.which:e.keyCode;if(t===13){i.executeOnEnter.call(r);return false}return true})}};view_model.current_poll_start_ts.subscribe(function(e){view_model.vote(null)});view_model.vote.subscribe(function(e){if(typeof e!="undefined"&&e!=null&&"name"in e&&e.name!=null)socket.emit("vote",e.name)});var timer=setInterval(view_model.tick,view_model.tick_time);view_model.chat_scrollbar=$("#chat_window").mCustomScrollbar({scrollInertia:100});$("*[title]").powerTip();ko.applyBindings(view_model);var socket=io.connect(location.host);socket.on("connect",function(){view_model.loading(false)});socket.on("id",function(e){cookie_set("id",e,7)});socket.on("state",function(e){view_model.state(e)});socket.on("config",function(e){view_model.config_location(e.location);view_model.config_entities(e.entities);if(e.location&&e.location.address!=view_model.config_location_input()){view_model.config_location_input(e.location.address);gmaps_handlers.config_location({formatted_address:e.location.address,geometry:{viewport:gmaps_handlers.decode_viewport(e.location.viewport)}})}if(view_model.pending_select){view_model.entity_detail(view_model.find_config_entity_by_name(view_model.pending_select));view_model.pending_select=null}if(!view_model.show_admin()&&view_model.zero_entities()){view_model.show_admin(true);$.powerTip.showTip($(".restaurant_settings h2>span"))}});socket.on("time",function(e){view_model.offset((new Date).getTime()-e)});socket.on("user_count",function(e){view_model.user_count(e)});socket.on("chat",function(e){view_model.chats.push(e);view_model.chat_scrollbar_update()});socket.on("disconnect",function(){view_model.loading(true)});socket.emit("register",{group_id:view_model.group_id,id:cookie_get("id")});view_model.config_location_autocomplete=new google.maps.places.Autocomplete($("#config_location_input")[0]);view_model.config_location_autocomplete.setTypes(["geocode"]);view_model.add_entity_input_autocomplete=new google.maps.places.Autocomplete($("#add_entity_input")[0]);view_model.add_entity_input_autocomplete.setTypes(["establishment"]);var gmaps_handlers={encode_viewport:function(e){var t=e.getNorthEast();var n=e.getSouthWest();return{ne:{lat:t.lat(),lng:t.lng()},sw:{lat:n.lat(),lng:n.lng()}}},decode_viewport:function(e){return new google.maps.LatLngBounds(new google.maps.LatLng(e.sw.lat,e.sw.lng),new google.maps.LatLng(e.ne.lat,e.ne.lng))},synthesize_viewport:function(e){var t=.002;var n=.003;return new google.maps.LatLngBounds(new google.maps.LatLng(e.lat()-t/2,e.lng()-n/2),new google.maps.LatLng(e.lat()+t/2,e.lng()+n/2))},encode_place:function(e){return{name:e.formatted_address?e.name:"Address",address:e.formatted_address?e.formatted_address:e.name,phone:e.formatted_phone_number||null,lat:e.geometry?e.geometry.location.lat():null,lng:e.geometry?e.geometry.location.lng():null}},config_location:function(e){var t="direct";if(typeof e==="undefined"){t="gmaps_api";e=view_model.config_location_autocomplete.getPlace()}if(e.geometry!=null){var n=e.geometry.viewport;if(!n)n=gmaps_handlers.synthesize_viewport(e.geometry.location);view_model.add_entity_input_autocomplete.setBounds(n);if(t=="gmaps_api"&&$("#config_location_input").is(":focus"))$("#add_entity_input").focus().select();view_model.update_location({address:e.formatted_address,viewport:gmaps_handlers.encode_viewport(n)})}},add_entity:function(e){e=e||view_model.add_entity_input_autocomplete.getPlace();encoded_place=gmaps_handlers.encode_place(e);view_model.add_entity(encoded_place);view_model.pending_select=encoded_place.name}};google.maps.event.addListener(view_model.config_location_autocomplete,"place_changed",gmaps_handlers.config_location);google.maps.event.addListener(view_model.add_entity_input_autocomplete,"place_changed",gmaps_handlers.add_entity)